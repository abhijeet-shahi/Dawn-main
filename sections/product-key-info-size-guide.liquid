{{ 'product-size-guide.css' | asset_url | stylesheet_tag }}

{%- comment -%}
  TASK A: Product Key Info + Size Guide Section
  
  This section displays core product information (title, price, variants)
  and includes a configurable Size Guide button that opens a drawer.
  
  Trade-offs:
  - Uses Dawn's existing variant picker patterns for consistency
  - Minimal custom CSS to leverage Dawn's design system
  - Schema-driven configuration for flexibility
{%- endcomment -%}

{%- comment -%}
  UI/UX Design: Constrained width, clear hierarchy, balanced spacing
  - Max-width container prevents excessive horizontal stretch
  - Vertical rhythm creates natural reading flow
  - Reduced visual weight on form elements
{%- endcomment -%}

<div class="product-key-info" id="ProductKeyInfo-{{ section.id }}" data-section="{{ section.id }}">
  <div class="product-key-info__inner">
    
    {%- comment -%} Primary: Product Title - Dominant hierarchy {%- endcomment -%}
    <h1 class="product-key-info__title">
      {{ product.title | escape }}
    </h1>

    {%- comment -%} Secondary: Price - Clear but not overpowering {%- endcomment -%}
    <div class="product-key-info__price">
      {%- if product.compare_at_price_max > product.price -%}
        <span class="product-key-info__price-sale">
          {{ product.price | money }}
        </span>
        <span class="product-key-info__price-compare">
          {{ product.compare_at_price_max | money }}
        </span>
      {%- else -%}
        <span class="product-key-info__price-regular">
          {{ product.price | money }}
        </span>
      {%- endif -%}
    </div>

    {%- comment -%} Tertiary: Variant Selector - Compact, functional {%- endcomment -%}
    {%- unless product.has_only_default_variant -%}
      <div class="product-key-info__options">
        <variant-selects 
          id="variant-selects-{{ section.id }}" 
          class="no-js-hidden" 
          data-section="{{ section.id }}"
          data-url="{{ product.url }}"
        >
          {%- for option in product.options_with_values -%}
            <div class="product-key-info__option-group">
              <label class="product-key-info__option-label" for="Option-{{ section.id }}-{{ forloop.index0 }}">
                {{ option.name }}
              </label>
              <div class="product-key-info__select-wrapper">
                <select
                  id="Option-{{ section.id }}-{{ forloop.index0 }}"
                  class="product-key-info__select"
                  name="options[{{ option.name | escape }}]"
                  form="{{ product_form_id }}"
                >
                  {%- for value in option.values -%}
                    <option 
                      value="{{ value | escape }}"
                      {% if option.selected_value == value %}selected="selected"{% endif %}
                    >
                      {{ value }}
                    </option>
                  {%- endfor -%}
                </select>
                <svg class="product-key-info__select-icon" aria-hidden="true" focusable="false" viewBox="0 0 10 6">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M9.354.646a.5.5 0 00-.708 0L5 4.293 1.354.646a.5.5 0 00-.708.708l4 4a.5.5 0 00.708 0l4-4a.5.5 0 000-.708z" fill="currentColor"/>
                </svg>
              </div>
            </div>
          {%- endfor -%}
        </variant-selects>
      </div>
    {%- endunless -%}

    {%- comment -%} Supporting: Size Guide CTA - Clean link style with ruler icon {%- endcomment -%}
    <div class="product-key-info__size-guide">
      <button 
        type="button"
        class="product-key-info__size-guide-btn"
        data-size-guide-trigger
        data-section-id="{{ section.id }}"
        data-metaobject-type="{{ section.settings.metaobject_type }}"
        data-empty-message="{{ section.settings.empty_state_message | escape }}"
        aria-expanded="false"
        aria-controls="SizeGuideDrawer-{{ section.id }}"
      >
        <svg class="product-key-info__size-guide-icon" aria-hidden="true" focusable="false" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="1.5"/>
          <line x1="3" y1="9" x2="21" y2="9" stroke-width="1.5"/>
          <line x1="9" y1="9" x2="9" y2="21" stroke-width="1.5"/>
        </svg>
        <span>{{ section.settings.button_label | escape }}</span>
      </button>
    </div>

  </div>
</div>

{%- comment -%}
  TASK B & C: Size Guide Drawer
  
  This drawer is populated dynamically via JavaScript using the Storefront API.
  The drawer markup is minimal to keep the Liquid clean.
  
  Trade-offs:
  - Client-side rendering for flexibility and real-time updates
  - Drawer content is fetched on first open (lazy loading)
  - ARIA attributes managed by JavaScript for dynamic states
{%- endcomment -%}

<div 
  id="SizeGuideDrawer-{{ section.id }}"
  class="size-guide-drawer"
  role="dialog"
  aria-modal="true"
  aria-labelledby="SizeGuideDrawer-Title-{{ section.id }}"
  data-size-guide-drawer
  hidden
>
  <div class="size-guide-drawer__overlay" data-drawer-overlay></div>
  <div class="size-guide-drawer__panel">
    <div class="size-guide-drawer__header">
      <h2 id="SizeGuideDrawer-Title-{{ section.id }}" class="size-guide-drawer__title">
        {{ section.settings.button_label | escape }}
      </h2>
      <button 
        type="button"
        class="size-guide-drawer__close"
        data-drawer-close
        aria-label="{{ 'accessibility.close' | t }}"
      >
        <svg aria-hidden="true" focusable="false" width="18" height="18" viewBox="0 0 18 18">
          <path d="M17 1L1 17M1 1l16 16" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
      </button>
    </div>
    <div class="size-guide-drawer__content" data-drawer-content>
      {%- comment -%} Content loaded dynamically via JavaScript {%- endcomment -%}
      <div class="size-guide-drawer__loading">
        <div class="loading-spinner"></div>
        <p>{{ 'general.loading' | t | default: 'Loading...' }}</p>
      </div>
    </div>
  </div>
</div>

{%- comment -%}
  Inject Storefront API credentials for JavaScript to use
  The token is configured in the section settings below
{%- endcomment -%}
<script>
  window.Shopify = window.Shopify || {};
  window.Shopify.storefrontToken = {{ section.settings.storefront_api_token | json }};
  window.Shopify.shop = {{ shop.permanent_domain | json }};
</script>

<script src="{{ 'product-size-guide.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Product Info Size Guide",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Size Guide Settings"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "Size Guide",
      "info": "Text displayed on the size guide button"
    },
    {
      "type": "text",
      "id": "metaobject_type",
      "label": "Metaobject Type",
      "default": "size_guide",
      "info": "The type of metaobject to fetch from Storefront API"
    },
    {
      "type": "textarea",
      "id": "empty_state_message",
      "label": "Empty State Message",
      "default": "No size guide available at this time.",
      "info": "Message shown when no metaobject data is found"
    },
    {
      "type": "header",
      "content": "Storefront API Configuration"
    },
    {
      "type": "text",
      "id": "storefront_api_token",
      "label": "Storefront API Access Token",
      "info": "Enter your Storefront API access token. Create one in: Settings > Apps and sales channels > Develop apps > Create an app > Configure Storefront API scopes (unauthenticated_read_metaobjects)"
    },
    {
      "type": "paragraph",
      "content": "⚠️ Security: Only use Storefront API tokens (public, read-only). Never use Admin API tokens in themes."
    }
  ],
  "presets": [
    {
      "name": "Product Info Size Guide"
    }
  ],
  "enabled_on": {
    "templates": ["product"]
  }
}
{% endschema %}
